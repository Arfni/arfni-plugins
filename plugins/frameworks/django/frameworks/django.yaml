metadata:
  name: django
  displayName: Django
  version: "1.0.0"
  description: "Django web framework for rapid development"
  category: runtime
  icon: django-icon.svg
  author: "Arfni Plugins Team"
  repository: "https://github.com/Arfni/arfni-plugins"
  documentation: "https://docs.djangoproject.com/"

# Compatible with which stack versions
compatibility:
  minStackVersion: "0.1"
  maxStackVersion: "1.0"

# Supported project types/patterns
supports:
  - pattern: "requirements.txt"
    required: true
    description: "Python requirements file"

  - pattern: "manage.py"
    required: true
    description: "Django management script"

  - pattern: "*.wsgi.py"
    required: false
    description: "WSGI application file"

# Auto-detection patterns from existing project
detection:
  - file: manage.py
    pattern: "django"
    confidence: high

  - file: requirements.txt
    pattern: "django"
    confidence: high

  - file: settings.py
    pattern: "INSTALLED_APPS"
    confidence: high

# Analysis extractors for existing Django projects
analysis:
  - file: requirements.txt
    pattern: "django==([0-9.]+)"
    capture: django_version

  - file: settings.py
    pattern: "ALLOWED_HOSTS\\s*=\\s*\\[(.*?)\\]"
    capture: allowed_hosts

# Default service configuration when dropped on canvas
serviceTemplate:
  kind: docker.container
  spec:
    build: "./apps/django"

    ports:
      - "8000:8000"

    # Only essential env vars, no hardcoded values
    env: {}

    # Volumes can be customized by user
    volumes: []

    health:
      httpGet:
        path: /health/
        port: 8000

# Property form for GUI (when user configures the node)
propertyForm:
  - name: pythonVersion
    label: Python Version
    type: select
    options:
      - "3.9"
      - "3.10"
      - "3.11"
      - "3.12"
    default: "3.11"
    description: "Python runtime version"
    required: true

  - name: port
    label: Application Port
    type: number
    default: 8000
    description: "Port for Django application"
    required: true

  - name: environment
    label: Environment
    type: select
    options:
      - development
      - staging
      - production
    default: development
    description: "Deployment environment"
    required: true

  - name: debug
    label: Debug Mode
    type: boolean
    default: false
    description: "Enable Django debug mode (auto-disabled in production)"

  - name: allowedHosts
    label: Allowed Hosts
    type: text
    default: ""
    placeholder: "localhost,127.0.0.1,example.com"
    description: "Comma-separated list of allowed hosts (leave empty for development)"
    required: false

  - name: secretKey
    label: Secret Key
    type: secret
    default: ""
    placeholder: "Generate with: python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'"
    description: "Django secret key (auto-generated if empty)"
    required: false

  - name: workers
    label: Gunicorn Workers
    type: number
    default: 4
    min: 1
    max: 16
    description: "Number of worker processes (recommended: 2-4 x CPU cores)"
    required: true

  - name: wsgiApplication
    label: WSGI Application
    type: text
    default: ""
    placeholder: "myproject.wsgi:application"
    description: "Path to WSGI application (auto-detected if empty)"
    required: false

  - name: enableStaticFiles
    label: Enable Static Files
    type: boolean
    default: true
    description: "Collect and serve static files"

  - name: enableMediaFiles
    label: Enable Media Files
    type: boolean
    default: true
    description: "Enable media file uploads"

  - name: volumeConfig
    label: Volume Configuration
    type: group
    fields:
      - name: mediaPath
        label: Media Files Path
        type: text
        default: "./media"
        description: "Host path for media files"
        condition: "enableMediaFiles === true"

      - name: staticPath
        label: Static Files Path
        type: text
        default: "./static"
        description: "Host path for static files"
        condition: "enableStaticFiles === true"

      - name: customVolumes
        label: Additional Volumes
        type: array
        itemType: object
        fields:
          - name: hostPath
            label: Host Path
            type: text
            required: true
          - name: containerPath
            label: Container Path
            type: text
            required: true
        default: []
        description: "Add custom volume mounts"

  - name: databaseConfig
    label: Database Configuration
    type: group
    fields:
      - name: autoConnectDatabase
        label: Auto-connect to Database
        type: boolean
        default: true
        description: "Automatically configure DATABASE_URL when connected to a database"

      - name: databaseUrl
        label: Database URL (Override)
        type: text
        default: ""
        placeholder: "postgresql://user:pass@host:port/dbname"
        description: "Override auto-generated DATABASE_URL"
        condition: "autoConnectDatabase === false"

  - name: redisConfig
    label: Cache Configuration
    type: group
    fields:
      - name: autoConnectRedis
        label: Auto-connect to Redis
        type: boolean
        default: false
        description: "Automatically configure REDIS_URL when connected to Redis"

      - name: redisUrl
        label: Redis URL (Override)
        type: text
        default: ""
        placeholder: "redis://host:6379/0"
        description: "Override auto-generated REDIS_URL"
        condition: "autoConnectRedis === false"

  - name: loggingConfig
    label: Logging Configuration
    type: group
    fields:
      - name: logLevel
        label: Log Level
        type: select
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR
          - CRITICAL
        default: INFO
        description: "Logging verbosity level"

      - name: accessLog
        label: Enable Access Logs
        type: boolean
        default: true
        description: "Log HTTP access requests"

      - name: errorLog
        label: Enable Error Logs
        type: boolean
        default: true
        description: "Log application errors"

# Connection handlers (for automatic configuration)
connections:
  - type: database
    handler: generateDatabaseUrl
    targetEnv: DATABASE_URL
    condition: "databaseConfig.autoConnectDatabase === true"

  - type: cache
    handler: generateRedisUrl
    targetEnv: REDIS_URL
    condition: "redisConfig.autoConnectRedis === true"

# Dynamic configuration based on connections
dynamicConfig:
  # When connected to PostgreSQL
  - trigger:
      connectionType: database
      targetType: postgres
    actions:
      - addEnv:
          DATABASE_URL: "postgresql://{{target.user}}:{{target.password}}@{{target.name}}:{{target.port}}/{{target.database}}"
      - addPackage:
          name: psycopg2-binary
          version: ">=2.9"

  # When connected to MySQL
  - trigger:
      connectionType: database
      targetType: mysql
    actions:
      - addEnv:
          DATABASE_URL: "mysql://{{target.user}}:{{target.password}}@{{target.name}}:{{target.port}}/{{target.database}}"
      - addPackage:
          name: mysqlclient
          version: ">=2.0"

  # When connected to Redis
  - trigger:
      connectionType: cache
      targetType: redis
    actions:
      - addEnv:
          REDIS_URL: "redis://{{target.name}}:{{target.port}}/0"
      - addPackage:
          name: django-redis
          version: ">=5.0"

# Common dependencies (suggested when adding Django)
commonDependencies:
  - postgres
  - redis
  - nginx

# Secrets this framework might need (not required)
suggestedSecrets:
  - DJANGO_SECRET_KEY
  - DATABASE_PASSWORD

# Example configurations
examples:
  - name: Development Setup
    description: Simple Django for local development
    propertyValues:
      environment: development
      debug: true
      allowedHosts: "localhost,127.0.0.1"
      workers: 2
      enableStaticFiles: true
      enableMediaFiles: false

  - name: Production Setup
    description: Production-ready Django configuration
    propertyValues:
      environment: production
      debug: false
      allowedHosts: "example.com,www.example.com"
      workers: 4
      enableStaticFiles: true
      enableMediaFiles: true
      loggingConfig:
        logLevel: WARNING

# Middleware and extensions
middleware:
  - name: CORS
    package: django-cors-headers
    description: "Handle Cross-Origin Resource Sharing"
    optional: true

  - name: REST Framework
    package: djangorestframework
    description: "Build RESTful APIs"
    optional: true

  - name: Celery
    package: celery
    description: "Asynchronous task queue"
    optional: true

# Health check endpoints
healthCheck:
  default:
    path: /health/
    interval: 30
    timeout: 10
    retries: 3

  custom:
    - name: Database Check
      path: /health/db/
      description: "Check database connectivity"

    - name: Redis Check
      path: /health/redis/
      description: "Check Redis connectivity"

# Container settings
container:
  user: django
  uid: 1000
  workdir: /app

# Resource recommendations
resources:
  development:
    memory: "512Mi"
    cpu: "0.5"

  production:
    memory: "2Gi"
    cpu: "1.0"